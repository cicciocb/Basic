//File System Stuff

void SaveDataToFile(String fileNameForSave, String DataToSave)
{
  Serial.println(fileNameForSave);
  //SPIFFS.begin();
  File f = SPIFFS.open(String(" /data/" + fileNameForSave + ".dat"), "w");
  if (!f)
  {
    PrintAndWebOut(F("file open failed"));
  }
  else
  {
    f.println(String(DataToSave + String('\r')));
    f.close();
  }
  return;
}



String LoadDataFromFile(String fileNameForSave)
{
  String WhatIwillReturn;
  //SPIFFS.begin();
  File f = SPIFFS.open(String(" /data/" + fileNameForSave + ".dat"), "r");
  if (!f)
  {
    fileOpenFail = 1;
    //Serial.print("file open failed  :");
    //Serial.println(fileNameForSave);
  }
  else
  {
    fileOpenFail = 0;
    WhatIwillReturn =  f.readStringUntil('\r');
    WhatIwillReturn.replace("\n", "");
    f.close();
    return WhatIwillReturn;
  }
}



/*
String BasicProgram___(int LineNumberToLookUp)
{
  if (ProgramName == "")
  {
    ProgramName = F("default");
  }
  delay(0);

  return LoadDataFromFile(String(ProgramName  + "/" + String(LineNumberToLookUp))) ;
  delay(0);
}


void BasicProgramWriteLine(int LineNumberToLookUp, String DataToWriteForProgramLine)
{
  if (ProgramName == "")
  {
    ProgramName = F("default");
  }
  delay(0);
  SaveDataToFile(String(ProgramName  + "/" +  String(LineNumberToLookUp)), DataToWriteForProgramLine);
  delay(0);
}


void LoadBasicProgramFromFlash__(String fileNameForSave)
{
  String lineToBeWrittenToFile;
  SPIFFS.begin();
  File f = SPIFFS.open(String("uploads/" + fileNameForSave), "r");
  if (!f)
  {
    PrintAndWebOut(F("file open failed"));
  }
  else
  {
    for (int i = 0; i <= TotalNumberOfLines; i++)
    {

      lineToBeWrittenToFile = f.readStringUntil('\r');
      lineToBeWrittenToFile.replace("\n", "");
      BasicProgramWriteLine(i,lineToBeWrittenToFile );
    }
    f.close();
  }
  return;
}
*/
//////////// santuzza calogero!!! /////////////

//static String programma[255];
static File BasicFileToSave;
static int  programma_nb_lines = 0;
static uint16_t  line_seeks[256];
static File BasicFileOpened;

String BasicProgram(int linenum)
{
//Serial.println("mi chiede linea " + String(linenum));
  if (linenum >= programma_nb_lines)
  {
	fileOpenFail = 1; 
	return "";
  }
  else
	fileOpenFail = 0; 
  
  if (linenum == 0)
		return "";

  //return programma[linenum - 1];	
  char buff[200];
  String ret;
  BasicFileOpened.seek(line_seeks[linenum-1], SeekSet);
  BasicFileOpened.readBytes(buff, line_seeks[linenum] - line_seeks[linenum-1]);
  buff[line_seeks[linenum] - line_seeks[linenum-1]] = '\0';
  ret = String(buff);
  ret.replace("\n","");
  ret.replace("\r","");
  
//  Serial.println(ret);
  return ret;
}

bool OpenToWriteOnFlash(String fileNameForWrite)
{
  BasicFileToSave = SPIFFS.open(String(fileNameForWrite), "w");
  if (!BasicFileToSave)
  {
    Serial.println(F("file write open failed"));
	return false;
  }
  return true;
}

bool WriteBasicLineOnFlash(String codeLine)
{
	int ret;
//	codeLine.replace("\r","");
//	codeLine.replace("\n","");
//Serial.println(codeLine);
	ret = BasicFileToSave.println(codeLine);
	if (ret == 0)
	{
		Serial.println(F("file write println failed"));
		return false;	
	}
	else
	{
	   return true;
	}	   

}

void CloseWriteOnFlash(void)
{
	BasicFileToSave.close();
}


void LoadBasicProgramFromFlash(String fileNameForRead)
{
//  Serial.println("sto facendo la lista degli indici di ogni linea");
  int i = 0;
  programma_nb_lines = 0;
  //SPIFFS.begin();
  BasicFileOpened.close();
  File f = SPIFFS.open(String(fileNameForRead), "r");
  BasicFileOpened = f;
  if (!f)
  {
    Serial.println(F("file open failed"));
  }
  else
  {
    for (i = 0; i <= TotalNumberOfLines; i++)
    {
      if (f.available() == 0) break;
      line_seeks[programma_nb_lines] = f.position();
      f.readStringUntil('\n');

//      Serial.println(programma[i]);
//      Serial.println(line_seeks[programma_nb_lines]);
      programma_nb_lines++;
    }
//    f.close();
  }

  //Serial.println("ho finito di caricare");
  return;
}



//void LoadBasicProgramFromFlash(String fileNameForRead)
//{
//  //Serial.println("sto caricando");
//  int i = 0;
//  programma_nb_lines = 0;
//  SPIFFS.begin();
//  File f = SPIFFS.open(String(fileNameForRead), "r");
//  if (!f)
//  {
//    Serial.println(F("file open failed"));
//  }
//  else
//  {
//    for (i = 0; i <= TotalNumberOfLines; i++)
//    {
//      if (f.available() == 0) break;
//      programma[i] = f.readStringUntil('\r');
//	  programma[i].trim();
////      Serial.println(programma[i]);
//      programma_nb_lines++;
//    }
//    f.close();
//  }
//  for (; i <= TotalNumberOfLines; i++)
//  {
//    programma[i] = "";
//  }
//  //Serial.println("ho finito di caricare");
//  return;
//}
